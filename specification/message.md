# メッセージ

*メッセージ*は, 2つのサービス間でやり取りされるJSONデータです.  
2つのサービスが異なるホストならば, パケットによってやり取りされます.


## メッセージの種類

メッセージの種類には, 要求メッセージと応答メッセージの2種類があります.  
要求メッセージは基本的なメッセージタイプで, 応答メッセージは返信用のメッセージタイプです.


## 階層化されたメッセージのルーティング

各要求メッセージは, ルーティングのために**ホスト**, **プロトコル**, **サービス**, **アクション**キーを持っています.  
それらは, 以下の手順で適切なメッセージハンドラに送られます.

1. コネクションは, 指定された**ホスト**にメッセージを送信します.
2. **ホスト**は, 指定された**プロトコル**にメッセージをルーティングします.
3. **プロトコル**は, 指定された**サービス**にメッセージをルーティングします.
4. **サービス**は, 指定された**action**をハンドルするためにハンドラにメッセージをルーティングします.

各応答メッセージは, ルーティングのために**host**, **reply_to**キーを持っています.  
それらは, 以下の手順で適切なメッセージ送信元に送信します.

1. コネクションは, 指定された**ホスト**にメッセージを送信します.
2. **ホスト**は, 指定された"ID"を持っているメッセージを送信元にルーティングします.


## 検証

メッセージルーティングの各層はメッセージが自分自身に宛てられているか調べるべきです(SHOULD).  
また, **ホスト**, **プロトコル**, **サービス**, **アクション**のうち，一つ以上が不明な場合，いかなる時もメッセージを無視するかもしれません(MAY).


## タイムアウト

Yayakaプロトコルは, メッセージのタイムアウトについて指定しません.


## JSON形式

### 要求

要求メッセージは次のプロパティを持ちます.

#### プロパティ

- 必須 **sender** object  
  オブジェクトは次のプロパティを持ちます.

  - 必須 **host** string  
    送信元のホスト

  - 推奨 **protocol** string  
    送信元のプロトコル

  - 推奨 **service** string  
    送信元のサービス

- 必須 **id** string  
  送信元のホスト内でユニークなID

- 必須 **host** string  
  宛先のホスト

- 必須 **protocol** string  
  宛先のプロトコル

- 必須 **service** string  
  宛先のサービス

- 必須 **action** string  
  メッセージの説明の為のテキスト

- 必須 **payload** object  
  メッセージ本体

- 非推奨 上記以外のプロパティ

#### 例

```json
{
  "sender": {
    "host": "host1.example.com",
    "protocol": "example",
    "service": "form"
  },
  "id": "0123456789",
  "host": "host2.example.com",
  "protocol": "example",
  "service": "repository",
  "action": "post example",
  "payload": {
    "text": "example text"
  }
}
```

### 応答

要求メッセージとの大きな違いは，応答メッセージは**reply_to**プロパティを持っていることと, **action**プロパティを持っていないことです.

返信メッセージの**送信元**プロパティにプロパティが含稀ている場合, 応答メッセージは**プロトコル**と**サービス**プロパティを持つべきです(SHOULD).

#### プロパティ

- 必須 **sender** object  
  必須, 任意, 推奨オブジェクトは, 次のプロパティを持っています.

  - 必須 **host** string  
    送信元のホスト

  - 推奨 **protocol** string  
    送信元のプロトコル

  - 推奨 **service** string  
    送信元のサービス

- 必須 **id** string  
  送信元のホスト内でユニークなID

- 必須 **reply-to** string  
  メッセージの返信用ID

- 必須 **host** string  
  宛先のホスト

- 任意 **protocol** string  
  宛先のプロトコル

- 任意 **service** string  
  宛先のサービス

- 必須 **payload** object  
  メッセージ本体

- 非推奨 上記以外のプロパティ

#### 例

```json
{
  "sender": {
    "host": "host2.example.com",
    "protocol": "example",
    "service": "repository"
  },
  "id": "abcdefghij",
  "reply-to": "0123456789",
  "host": "host1.example.com",
  "protocol": "example",
  "service": "form",
  "payload": {
    "status": "ok"
  }
}
```
